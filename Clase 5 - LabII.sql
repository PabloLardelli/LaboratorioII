--CLASE 5

--UNIDAD 1 - PAG 15 - 8. Emitir un listado que muestre la cantidad total de artículos vendidos, el
--importe total vendido y el promedio del importe vendido por vendedor y por cliente;
--para los casos en que el importe total vendido esté entre 200 y 600 y para códigos de cliente que oscilen entre 1 y 5.select sum(d.cantidad) 'Cantidad de Art.', sum(d.pre_unitario * d.cantidad) 'Importe total',		sum(d.cantidad*d.pre_unitario) / count(distinct d.nro_factura) 'Promedio', c.ape_cliente +' ' +c.nom_cliente 'Cliente',		v.ape_vendedor +' '+v.nom_vendedor 'Vendedor'from articulos ajoin detalle_facturas d on a.cod_articulo = d.cod_articulojoin facturas f on f.nro_factura = d.nro_facturajoin clientes c on f.cod_cliente = c.cod_clientejoin vendedores v on v.cod_vendedor = f.cod_vendedorwhere c.cod_cliente between 1 and 5group by c.ape_cliente +' ' +c.nom_cliente,		v.ape_vendedor +' '+v.nom_vendedorhaving sum(d.pre_unitario * d.cantidad) between 2000 and 6000--9. ¿Cuáles son los vendedores cuyo promedio de facturación el mes pasado supera los $ 800?select v.nom_vendedor +' '+v.nom_vendedor Vendedor,  sum(d.cantidad*d.pre_unitario) / count(distinct d.nro_factura) 'Promedio'from facturas fjoin vendedores v on f.cod_vendedor = v.cod_vendedorjoin detalle_facturas d on d.nro_factura = f.nro_facturawhere month(f.fecha) = datediff(month, f.fecha,GETDATE())-1 --MONTH(GETDATE())-1 group by v.nom_vendedor +' '+v.nom_vendedor having (sum(d.cantidad*d.pre_unitario) / count(distinct d.nro_factura)) > 800order by 2 --SUBCONSULTAS EN EL HAVING--ejemplo 1: listar los vendedores cuyas ventas totales sea superior al promedio general de ventasselect v.cod_vendedor Codigo, v.ape_vendedor+' '+v.nom_vendedor Vendedor, sum(d.cantidad*d.pre_unitario) Ventasfrom vendedores vjoin facturas f on f.cod_vendedor = v.cod_vendedorjoin detalle_facturas d on d.nro_factura = f.nro_facturagroup by v.cod_vendedor, v.ape_vendedor+' '+v.nom_vendedorhaving sum(d.cantidad*d.pre_unitario) > (select sum(d.cantidad*d.pre_unitario)/count(distinct d.nro_factura)										from facturas f										join detalle_facturas d on d.nro_factura = f.nro_factura)order by 1--ejemplo 2: listar los vendedores cuyas promedio ventas sea superior al promedio general de ventasselect v.cod_vendedor Codigo, v.ape_vendedor+' '+v.nom_vendedor Vendedor, sum(d.cantidad*d.pre_unitario)/count(distinct d.nro_factura) Ventasfrom vendedores vjoin facturas f on f.cod_vendedor = v.cod_vendedorjoin detalle_facturas d on d.nro_factura = f.nro_facturagroup by v.cod_vendedor, v.ape_vendedor+' '+v.nom_vendedorhaving sum(d.cantidad*d.pre_unitario)/count(distinct d.nro_factura) > (select sum(d.cantidad*d.pre_unitario)/count(distinct d.nro_factura)										from facturas f										join detalle_facturas d on d.nro_factura = f.nro_factura)order by 1--Ejercicio para presentar: unidad: 2 pag. 4 ejercicio 7--7. Se quiere saber la fecha de la primera y última venta, el importe total
--facturado por cliente para los años que oscilen entre el 2010 y 2015 y que
--el importe promedio facturado sea menor que el importe promedio total para ese cliente. select c.cod_cliente Codigo, c.ape_cliente+' '+c.nom_cliente Cliente, format(min(f.fecha),'dd/MM/yyyy') 'Fecha 1° venta',format(max(f.fecha),'dd/MM/yyyy') 'Fecha ult. venta',	sum(d.cantidad*d.pre_unitario) 'Total Facturado'from facturas fjoin clientes c on f.cod_cliente = c.cod_clientejoin detalle_facturas d on d.nro_factura = f.nro_facturawhere year(f.fecha) between 2010 and 2015group by c.cod_cliente, c.ape_cliente+' '+c.nom_clientehaving sum(d.cantidad*d.pre_unitario) < (select sum(d.cantidad*d.pre_unitario)/count(distinct d.nro_factura)										from facturas f										join detalle_facturas d on d.nro_factura = f.nro_factura)order by 1--Pág. 6 - Ej. 6--Descontar un 3,5% los precios de los artículos que se vendieron menos de 5 unidades los últimos 3 meses.select a.descripcion Articulo, a.pre_unitario Precio, a.pre_unitario * 0.965 'Precio descontado'from articulos a join detalle_facturas d on d.cod_articulo = a.cod_articulojoin facturas f on f.nro_factura = d.nro_facturawhere 5 < any (select sum(d.cantidad)				from detalle_facturas d				--where a.cod_articulo = d.cod_articulo				GROUP BY D.cod_articulo) and month(f.fecha) = DATEDIFF(month, getdate(),f.fecha)-3and year(f.fecha) = year(GETDATE())--Ejemplo pizarronselect a.descripcion, a.pre_unitario*0.965from articulos awhere 5 < any (select sum (d.cantidad)				from detalle_facturas d				join facturas f on d.nro_factura = d.nro_factura				where d.cod_articulo = a.cod_articulo				and month(f.fecha) = month(GETDATE())-3				group by d.cod_articulo)